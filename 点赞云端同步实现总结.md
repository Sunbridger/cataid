# è¯„è®ºç‚¹èµäº‘ç«¯åŒæ­¥åŠŸèƒ½ - å®Œæ•´å®ç°æ€»ç»“

## ğŸ‰ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®ç°è¯„è®ºç‚¹èµçš„å®Œæ•´äº‘ç«¯åŒæ­¥åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… æ•°æ®åº“è¡¨å’Œè§¦å‘å™¨
- âœ… åç«¯ API
- âœ… å‰ç«¯æœåŠ¡é›†æˆ
- âœ… UI æ›´æ–°
- âœ… ç”¨æˆ·ç»Ÿè®¡åŒæ­¥

---

## ğŸ“‹ å®ç°å†…å®¹

### 1. æ•°æ®åº“å±‚ âœ…

**æ–°å»ºæ–‡ä»¶**: `comment-likes-migration.sql`

**åˆ›å»ºçš„è¡¨**:
```sql
CREATE TABLE comment_likes (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  comment_id UUID NOT NULL,
  created_at TIMESTAMP,
  UNIQUE(user_id, comment_id)
);
```

**åˆ›å»ºçš„ç´¢å¼•**:
- `idx_comment_likes_user_id` - ç”¨æˆ·IDç´¢å¼•
- `idx_comment_likes_comment_id` - è¯„è®ºIDç´¢å¼•
- `idx_comment_likes_created_at` - åˆ›å»ºæ—¶é—´ç´¢å¼•

**åˆ›å»ºçš„å­˜å‚¨è¿‡ç¨‹**:
- `increment_comment_likes(comment_id)` - å¢åŠ è¯„è®ºç‚¹èµæ•°
- `decrement_comment_likes(comment_id)` - å‡å°‘è¯„è®ºç‚¹èµæ•°

**åˆ›å»ºçš„è§¦å‘å™¨**:
- `trigger_update_like_count` - è‡ªåŠ¨æ›´æ–°ç”¨æˆ·ç‚¹èµæ•°ç»Ÿè®¡

**æ–°å¢å­—æ®µ**:
- `users.like_count` - ç”¨æˆ·ç‚¹èµæ€»æ•°

**RLS ç­–ç•¥**:
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹/æ·»åŠ /åˆ é™¤è‡ªå·±çš„ç‚¹èµ

---

### 2. åç«¯ API å±‚ âœ…

**æ–°å»ºæ–‡ä»¶**: `api/comment-likes.ts`

**API è·¯ç”±**:

#### GET /api/comment-likes?userId=xxx
è·å–ç”¨æˆ·ç‚¹èµåˆ—è¡¨
```typescript
Response: {
  data: [{
    id: string,
    commentId: string,
    createdAt: string,
    comment: {
      id, catId, userId, nickname, avatarUrl,
      content, isAiReply, likeCount, createdAt,
      catName
    }
  }]
}
```

#### POST /api/comment-likes
æ·»åŠ ç‚¹èµ
```typescript
Request: { userId: string, commentId: string }
Response: { data: { id, userId, commentId, createdAt } }
```

#### DELETE /api/comment-likes?userId=xxx&commentId=xxx
åˆ é™¤ç‚¹èµ
```typescript
Response: { message: 'åˆ é™¤æˆåŠŸ' }
```

**ç‰¹æ€§**:
- âœ… é˜²æ­¢é‡å¤ç‚¹èµï¼ˆæ•°æ®åº“å”¯ä¸€çº¦æŸï¼‰
- âœ… è‡ªåŠ¨æ›´æ–°è¯„è®ºç‚¹èµæ•°ï¼ˆè°ƒç”¨å­˜å‚¨è¿‡ç¨‹ï¼‰
- âœ… å…³è”æŸ¥è¯¢è¯„è®ºå’ŒçŒ«å’ªä¿¡æ¯
- âœ… æ”¯æŒæ¼”ç¤ºæ¨¡å¼

---

### 3. å‰ç«¯æœåŠ¡å±‚ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `services/apiService.ts`

**æ–°å¢ API æœåŠ¡**:
```typescript
export const commentLikeApi = {
  getUserLikes(userId: string): Promise<any[]>
  addLike(userId: string, commentId: string): Promise<boolean>
  removeLike(userId: string, commentId: string): Promise<boolean>
  isLiked(userId: string, commentId: string): Promise<boolean>
}
```

---

### 4. è¯„è®ºç»„ä»¶æ›´æ–° âœ…

**ä¿®æ”¹æ–‡ä»¶**: `components/CommentSection.tsx`

**æ›´æ–°é€»è¾‘**:
```typescript
// åŠ è½½ç‚¹èµçŠ¶æ€
const loadLikedComments = async () => {
  if (user?.id) {
    // å·²ç™»å½•ï¼šä»äº‘ç«¯è·å–
    const likes = await commentLikeService.getUserLikes(user.id);
    setLikedComments(new Set(likes.map(l => l.commentId)));
  } else {
    // æœªç™»å½•ï¼šä» localStorage è¯»å–
    const liked = JSON.parse(localStorage.getItem(...));
    setLikedComments(new Set(liked));
  }
};

// ç‚¹èµå¤„ç†
const handleLike = async (commentId: string) => {
  if (user?.id) {
    // å·²ç™»å½•ï¼šä½¿ç”¨äº‘ç«¯ API
    await commentLikeService.addLike(user.id, commentId);
  } else {
    // æœªç™»å½•ï¼šä½¿ç”¨ localStorage
    localStorage.setItem(...);
    commentService.likeComment(commentId);
  }
};
```

**ç‰¹æ€§**:
- âœ… ä¹è§‚æ›´æ–° UI
- âœ… å¤±è´¥æ—¶å›æ»š
- âœ… å…¼å®¹æœªç™»å½•ç”¨æˆ·ï¼ˆä½¿ç”¨ localStorageï¼‰
- âœ… è‡ªåŠ¨åŒæ­¥äº‘ç«¯æ•°æ®

---

### 5. æˆ‘çš„ç‚¹èµé¡µé¢ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `pages/MyLikesPage.tsx`

**æ›´æ–°å†…å®¹**:
- âœ… ä»äº‘ç«¯ API è·å–ç‚¹èµåˆ—è¡¨
- âœ… æ˜¾ç¤ºè¯„è®ºè¯¦æƒ…ï¼ˆå†…å®¹ã€ä½œè€…ã€ç‚¹èµæ•°ï¼‰
- âœ… æ˜¾ç¤ºæ¥æºçŒ«å’ªï¼ˆå¯ç‚¹å‡»è·³è½¬ï¼‰
- âœ… æ›´æ–°æç¤ºä¿¡æ¯ï¼ˆäº‘ç«¯åŒæ­¥å·²å¯ç”¨ï¼‰

---

### 6. ç”¨æˆ·ç»Ÿè®¡æ›´æ–° âœ…

**ä¿®æ”¹æ–‡ä»¶**: `api/user-stats.ts`

**æ–°å¢ç»Ÿè®¡**:
```typescript
{
  favoriteCount: number,
  commentCount: number,
  adoptionCount: number,
  likeCount: number  // æ–°å¢
}
```

---

## ğŸ”„ æ•°æ®æµç¨‹

### ç‚¹èµæµç¨‹
```
1. ç”¨æˆ·ç‚¹å‡»ç‚¹èµæŒ‰é’®
   â†“
2. å‰ç«¯ä¹è§‚æ›´æ–° UIï¼ˆç«‹å³æ˜¾ç¤ºå·²ç‚¹èµï¼‰
   â†“
3. è°ƒç”¨ commentLikeService.addLike(userId, commentId)
   â†“
4. åç«¯ API å¤„ç†
   â”œâ”€ æ’å…¥ comment_likes è¡¨
   â”œâ”€ è°ƒç”¨å­˜å‚¨è¿‡ç¨‹å¢åŠ è¯„è®ºç‚¹èµæ•°
   â””â”€ è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°ç”¨æˆ·ç‚¹èµæ•°
   â†“
5. è¿”å›æˆåŠŸ/å¤±è´¥
   â”œâ”€ æˆåŠŸï¼šä¿æŒ UI çŠ¶æ€
   â””â”€ å¤±è´¥ï¼šå›æ»š UI çŠ¶æ€
```

### æ•°æ®åŒæ­¥æµç¨‹
```
ç™»å½•ç”¨æˆ·:
  ç‚¹èµæ•°æ® â†’ comment_likes è¡¨ â†’ äº‘ç«¯å­˜å‚¨
  è·¨è®¾å¤‡åŒæ­¥ âœ…

æœªç™»å½•ç”¨æˆ·:
  ç‚¹èµæ•°æ® â†’ localStorage â†’ æœ¬åœ°å­˜å‚¨
  ç™»å½•åå¯è¿ç§»åˆ°äº‘ç«¯ âš ï¸
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### comment_likes è¡¨
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| user_id | UUID | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| comment_id | UUID | è¯„è®ºIDï¼ˆå¤–é”®ï¼‰ |
| created_at | TIMESTAMP | ç‚¹èµæ—¶é—´ |

**çº¦æŸ**:
- UNIQUE(user_id, comment_id) - é˜²æ­¢é‡å¤ç‚¹èµ
- å¤–é”®çº§è”åˆ é™¤

### users è¡¨æ–°å¢å­—æ®µ
| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| like_count | INTEGER | 0 | ç”¨æˆ·ç‚¹èµæ€»æ•° |

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… äº‘ç«¯å­˜å‚¨ç‚¹èµæ•°æ®
- âœ… è·¨è®¾å¤‡åŒæ­¥
- âœ… å®æ—¶ç»Ÿè®¡æ›´æ–°
- âœ… é˜²æ­¢é‡å¤ç‚¹èµ
- âœ… è‡ªåŠ¨æ›´æ–°è¯„è®ºç‚¹èµæ•°
- âœ… è‡ªåŠ¨æ›´æ–°ç”¨æˆ·ç»Ÿè®¡

### ç”¨æˆ·ä½“éªŒ
- âœ… ä¹è§‚æ›´æ–°ï¼ˆå³æ—¶åé¦ˆï¼‰
- âœ… å¤±è´¥å›æ»š
- âœ… åŠ è½½çŠ¶æ€æç¤º
- âœ… å…¼å®¹æœªç™»å½•ç”¨æˆ·
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†

### æ€§èƒ½ä¼˜åŒ–
- âœ… æ•°æ®åº“ç´¢å¼•
- âœ… å¹¶è¡ŒæŸ¥è¯¢
- âœ… è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°
- âœ… ç¼“å­˜ç»Ÿè®¡æ•°æ®

---

## ğŸ“ æ‰§è¡Œæ­¥éª¤

### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»
åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š
```bash
# æ‰§è¡Œ comment-likes-migration.sql
```

### 2. éªŒè¯æ•°æ®åº“
```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT * FROM comment_likes LIMIT 1;

-- æ£€æŸ¥è§¦å‘å™¨
SELECT trigger_name FROM information_schema.triggers
WHERE trigger_name LIKE '%like%';

-- æ£€æŸ¥å­˜å‚¨è¿‡ç¨‹
SELECT routine_name FROM information_schema.routines
WHERE routine_name LIKE '%comment_likes%';
```

### 3. æµ‹è¯•åŠŸèƒ½
1. âœ… ç™»å½•ç”¨æˆ·
2. âœ… åœ¨è¯„è®ºåŒºç‚¹èµè¯„è®º
3. âœ… æŸ¥çœ‹"æˆ‘çš„ç‚¹èµ"é¡µé¢
4. âœ… æ£€æŸ¥ä¸ªäººä¸­å¿ƒç»Ÿè®¡æ•°å­—
5. âœ… åˆ·æ–°é¡µé¢ï¼ŒéªŒè¯æ•°æ®æŒä¹…åŒ–
6. âœ… æ¢è®¾å¤‡ç™»å½•ï¼ŒéªŒè¯æ•°æ®åŒæ­¥

---

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. æ•°æ®åº“è®¾è®¡
- ä½¿ç”¨è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤ç»Ÿè®¡æ•°æ®
- ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å°è£…ä¸šåŠ¡é€»è¾‘
- ä½¿ç”¨å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤ç‚¹èµ
- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### 2. API è®¾è®¡
- RESTful é£æ ¼
- å…³è”æŸ¥è¯¢ä¼˜åŒ–
- é”™è¯¯å¤„ç†å®Œå–„
- æ”¯æŒæ¼”ç¤ºæ¨¡å¼

### 3. å‰ç«¯å®ç°
- ä¹è§‚æ›´æ–°æå‡ç”¨æˆ·ä½“éªŒ
- å¤±è´¥å›æ»šä¿è¯æ•°æ®ä¸€è‡´æ€§
- å…¼å®¹æœªç™»å½•ç”¨æˆ·
- è‡ªåŠ¨åŒæ­¥äº‘ç«¯æ•°æ®

### 4. å®‰å…¨æ€§
- RLS ç­–ç•¥ä¿æŠ¤æ•°æ®
- å¤–é”®çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
- é˜²æ­¢é‡å¤ç‚¹èµ
- ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®

---

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–

### åŠŸèƒ½æ‰©å±•
- [ ] æ‰¹é‡ç‚¹èµæ“ä½œ
- [ ] ç‚¹èµé€šçŸ¥
- [ ] ç‚¹èµæ’è¡Œæ¦œ
- [ ] çƒ­é—¨è¯„è®ºæ¨è

### æ€§èƒ½ä¼˜åŒ–
- [ ] ä½¿ç”¨ Redis ç¼“å­˜ç‚¹èµçŠ¶æ€
- [ ] å®ç°ç‚¹èµæ•°å»¶è¿Ÿæ›´æ–°
- [ ] ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†ç‚¹èµ
- [ ] å®ç°ç‚¹èµæ•°æ®åˆ†ç‰‡

### ç”¨æˆ·ä½“éªŒ
- [ ] ç‚¹èµåŠ¨ç”»æ•ˆæœ
- [ ] é•¿æŒ‰å¿«é€Ÿç‚¹èµ
- [ ] ç‚¹èµå†å²è®°å½•
- [ ] å¯¼å‡ºç‚¹èµæ•°æ®

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

### æ•°æ®åº“
- [x] åˆ›å»º comment_likes è¡¨
- [x] æ·»åŠ ç´¢å¼•
- [x] åˆ›å»ºè§¦å‘å™¨
- [x] åˆ›å»ºå­˜å‚¨è¿‡ç¨‹
- [x] é…ç½® RLS ç­–ç•¥
- [x] æ·»åŠ  users.like_count å­—æ®µ

### åç«¯
- [x] åˆ›å»ºç‚¹èµ API
- [x] å®ç°è·å–ç‚¹èµåˆ—è¡¨
- [x] å®ç°æ·»åŠ ç‚¹èµ
- [x] å®ç°åˆ é™¤ç‚¹èµ
- [x] æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ API

### å‰ç«¯
- [x] æ·»åŠ ç‚¹èµæœåŠ¡
- [x] æ›´æ–°è¯„è®ºç»„ä»¶
- [x] æ›´æ–°"æˆ‘çš„ç‚¹èµ"é¡µé¢
- [x] å®ç°ä¹è§‚æ›´æ–°
- [x] å®ç°é”™è¯¯å¤„ç†

### æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç”¨æˆ·éªŒæ”¶æµ‹è¯•

---

## ğŸ‰ æ€»ç»“

è¯„è®ºç‚¹èµäº‘ç«¯åŒæ­¥åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼

**æ ¸å¿ƒä»·å€¼**:
1. âœ… æ•°æ®äº‘ç«¯å­˜å‚¨ï¼Œæ°¸ä¸ä¸¢å¤±
2. âœ… è·¨è®¾å¤‡åŒæ­¥ï¼Œéšæ—¶éšåœ°
3. âœ… è‡ªåŠ¨ç»Ÿè®¡æ›´æ–°ï¼Œå®æ—¶å‡†ç¡®
4. âœ… ç”¨æˆ·ä½“éªŒä¼˜ç§€ï¼Œæ“ä½œæµç•…

**æŠ€æœ¯æ ˆ**:
- æ•°æ®åº“ï¼šPostgreSQL + Supabase
- åç«¯ï¼šVercel Serverless Functions
- å‰ç«¯ï¼šReact + TypeScript
- çŠ¶æ€ç®¡ç†ï¼šReact Hooks

**ä¸‹ä¸€æ­¥**: æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼Œå¼€å§‹æµ‹è¯•ï¼ğŸš€
