# 客服系统技术方案与原型设计

## 1. 方案概述

目前平台仅提供基础信息展示，缺乏实时的用户支持渠道。本方案旨在构建一个**实时在线客服系统 (Live Chat)**，允许用户与管理员（客服）进行即时沟通。

**核心策略：**
*   **即时通讯**：基于 Supabase Realtime 实现毫秒级消息推送。
*   **智能兜底**：客服离线时，自动转为“留言模式”，管理员上线后可回复（类似邮件/工单）。
*   **统一管理**：管理员在后台统一管理所有会话，无需切换其他工具。

---

## 2. 技术架构

利用现有的 Supabase 架构，无需引入额外的 WebSocket 服务（如 Socket.io）。

### 2.1 数据库设计 (Schema)

需要新增两张核心表：

#### A. 会话表 (`support_sessions`)
记录用户与客服的每一次“对话周期”。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | `uuid` | 主键 |
| `user_id` | `uuid` | 发起咨询的用户 ID (FK to users) |
| `admin_id` | `uuid` | 接待的管理员 ID (可为空，表示待接入) |
| `status` | `enum` | `'active'` (进行中), `'closed'` (已结束) |
| `last_message` | `text` | 最后一条消息预览（用于列表展示） |
| `last_message_at` | `timestamptz` | 用于排序 |
| `unread_count` | `int` | 管理员侧的未读数 |

#### B. 消息表 (`support_messages`)
记录具体的聊天内容。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | `uuid` | 主键 |
| `session_id` | `uuid` | 关联的会话 ID |
| `sender_id` | `uuid` | 发送者 ID (用户或管理员) |
| `content` | `text` | 消息内容 |
| `msg_type` | `enum` | `'text'`, `'image'`, `'system'` (系统提示) |
| `is_read` | `boolean` | 是否已读 |
| `created_at` | `timestamptz` | 发送时间 |

### 2.2 权限控制 (RLS)

*   **用户**：只能 `SELECT/INSERT` 自己 `user_id` 关联的会话和消息。
*   **管理员**：可以 `SELECT/UPDATE` 所有会话，`INSERT` 消息。

---

## 3. 交互原型设计

### 3.1 用户侧：客服聊天窗口
**入口**：个人中心 -> 服务中心 -> 联系客服

**界面布局：**
*   **顶部导航栏**：
    *   标题：“在线客服”
    *   状态指示灯：🟢 客服在线 / ⚪️ 客服离线（根据管理员在线状态显示）
*   **消息流区域 (主体)**：
    *   **系统欢迎语**：“您好，我是您的专属领养顾问，请问有什么可以帮您？”
    *   **常见问题快捷入口 (Chips)**：“领养流程”、“疫苗接种”、“店铺地址”。点击可直接发送。
    *   **消息气泡**：
        *   用户消息：粉色背景，右侧同头像。
        *   客服消息：白色背景，左侧客服头像。
        *   时间戳：每隔 5 分钟显示一次。
*   **底部输入区**：
    *   输入框（支持 Auto-height）。
    *   功能按钮：[表情] [图片上传 (+)]。
    *   发送按钮。

### 3.2 管理员侧：客服工作台
**入口**：管理员后台 -> 消息中心

**界面布局 (分栏设计)：**
*   **左侧：会话列表**
    *   **筛选**：全部 / 待接入 / 进行中。
    *   **列表项**：用户头像 | 用户昵称 | 最后消息预览 | 时间 | **红色未读徽标**。
*   **右侧：对话详情**
    *   **顶部**：当前沟通用户信息（点击可跳转用户画像/领养记录）。
    *   **快捷操作栏**：[结束会话] [转交工单]。
    *   **消息流**：同用户侧。
    *   **侧边栏 (可选)**：快捷回复库（如：“领养协议需要您到店签署...”）。

---

## 4. 关键逻辑流程

### 4.1 发送消息流程
1.  用户进入“联系客服”页面。
2.  前端查询是否存在状态为 `active` 的 `support_session`。
    *   若不存在，创建一个新 Session。
3.  用户发送消息 -> 写入 `support_messages`。
4.  **触发器 (Database Trigger)** 自动更新 `support_sessions` 的 `last_message` 和 `last_message_at`。

### 4.2 实时接收流程
1.  管理员后台订阅 `support_messages` 表的 `INSERT` 事件。
2.  收到新消息 -> 播放提示音 -> 更新左侧列表未读数。
3.  管理员点击会话 -> 标记消息为 `is_read` -> 发送回复。
4.  用户端同样订阅该 Session 的消息 -> 实时显示客服回复。

### 4.3 离线处理
*   如果管理员 5 分钟未回复，系统自动发送：“客服暂时忙碌，您的问题已记录，我们会尽快通过系统通知回复您。”
*   管理员后续回复时，系统通过现有的 **通知中心 (Notifications)** 发送一条提醒给用户：“客服回复了您的咨询”。

---

## 5. 开发阶段规划

### 第一阶段：核心聊天功能
*   完成数据库建表和 RLS 策略。
*   实现基础的文本消息发送与接收。
*   用户端聊天界面开发。
*   管理员端基础回复功能。

### 第二阶段：体验优化
*   支持图片发送（利用 Supabase Storage）。
*   添加“输入中...”状态显示。
*   添加“常见问题”自动回复机器人。

### 第三阶段：多客服与统计
*   会话分配机制（多个管理员时，谁认领谁负责）。
*   客服满意度评价。
