# 🔧 发布人信息和收藏通知问题修复

## 🐛 问题诊断

### 问题 1: 猫咪详情页不显示发布人信息

**原因**:
- 缺少 `/api/cats/[id]` 路由处理
- 前端调用 `getById` 时请求 `/cats/${id}`，但后端没有对应的处理

**解决方案**:
✅ 已创建 `api/cats/[id].ts` 文件来处理单个猫咪的获取
✅ 确保返回数据中包含 `userId` 字段（驼峰命名）

---

### 问题 2: 收藏通知不工作

**可能的原因**:
1. 数据库中猫咪记录没有 `user_id` 字段
2. 现有猫咪数据的 `user_id` 为 NULL
3. Realtime 订阅有问题

**需要检查的步骤**:

#### 步骤 1: 检查数据库表结构

在 Supabase SQL Editor 中执行：

```sql
-- 1. 检查 cats 表是否有 user_id 字段
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'cats' AND column_name = 'user_id';

-- 2. 如果没有 user_id 字段，添加它
ALTER TABLE cats
ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES users(id);

-- 3. 查看现有猫咪数据
SELECT id, name, user_id, created_at
FROM cats
ORDER BY created_at DESC
LIMIT 10;
```

#### 步骤 2: 更新现有猫咪数据

如果现有猫咪的 `user_id` 为 NULL，需要更新：

```sql
-- 方案 1: 将所有猫咪关联到第一个用户（临时方案）
UPDATE cats
SET user_id = (SELECT id FROM users ORDER BY created_at LIMIT 1)
WHERE user_id IS NULL;

-- 方案 2: 将所有猫咪关联到特定用户
-- 先查找用户ID
SELECT id, nickname FROM users;

-- 然后更新
UPDATE cats
SET user_id = '你的用户ID'
WHERE user_id IS NULL;
```

#### 步骤 3: 测试收藏通知

1. **准备两个账号**:
   - 账号 A: 发布猫咪的用户
   - 账号 B: 收藏猫咪的用户

2. **用账号 A 发布一只新猫咪**:
   - 进入"发布猫咪"页面
   - 填写猫咪信息
   - 提交（这样会自动关联 user_id）

3. **用账号 B 收藏这只猫咪**:
   - 打开猫咪详情页
   - 点击收藏按钮（爱心图标）

4. **检查账号 A 是否收到通知**:
   - 查看顶部是否弹出 Toast 提示
   - 查看"消息通知"是否有未读数量
   - 打开通知页面查看详情

#### 步骤 4: 检查 Console 日志

在浏览器 Console 中查找：

```
[API] Creating favorite notification for user xxx
[API] Favorite notification created successfully
[Notification] ========== NEW NOTIFICATION RECEIVED ==========
[Notification] Payload: {...}
```

如果没有这些日志，说明：
- 可能是 `cat.user_id` 为空
- 可能是 Realtime 订阅有问题

---

## ✅ 已完成的修复

### 1. 创建了 `/api/cats/[id]` 路由

**文件**: `api/cats/[id].ts`

**功能**:
- 处理单个猫咪的获取请求
- 返回猫咪详情，包含 `userId` 字段
- 返回评论数量

**关键代码**:
```typescript
return res.status(200).json({
  data: {
    ...cat,
    userId: cat.user_id, // 添加驼峰命名的 userId
    commentCount: commentCount || 0,
  }
});
```

### 2. 收藏通知逻辑已添加

**文件**: `api/interactions.ts`

**功能**:
- 在用户收藏猫咪时创建通知
- 避免自己收藏自己的猫
- 通过 Realtime 推送到前端

---

## 🎯 下一步操作

### 必须执行的 SQL

在 Supabase Dashboard 的 SQL Editor 中执行：

```sql
-- 1. 确保 cats 表有 user_id 字段
ALTER TABLE cats
ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES users(id);

-- 2. 查看哪些猫咪没有 user_id
SELECT id, name, user_id
FROM cats
WHERE user_id IS NULL;

-- 3. 更新现有猫咪的 user_id
-- 先查找一个用户ID
SELECT id, nickname FROM users LIMIT 5;

-- 然后更新（替换 'YOUR_USER_ID' 为实际的用户ID）
UPDATE cats
SET user_id = 'YOUR_USER_ID'
WHERE user_id IS NULL;
```

### 测试步骤

1. **重启开发服务器**:
   ```bash
   npm run dev
   ```

2. **测试发布人信息**:
   - 打开任意猫咪详情页
   - 应该在顶部看到发布人信息卡片

3. **测试收藏通知**:
   - 用两个不同的账号
   - 账号 B 收藏账号 A 发布的猫咪
   - 账号 A 应该收到通知

---

## 📝 调试技巧

### 如果发布人信息还是不显示

1. 打开浏览器 Console
2. 查找日志:
   ```
   [CatDetailsPage] cat.userId: xxx
   [CatDetailsPage] publisher: {...}
   ```

3. 如果 `cat.userId` 为 undefined:
   - 检查 API 返回的数据
   - 在 Network 标签查看 `/cats/[id]` 的响应

### 如果收藏通知不工作

1. 打开浏览器 Console
2. 收藏猫咪后查找:
   ```
   [API] Creating favorite notification for user xxx
   [Notification] ========== NEW NOTIFICATION RECEIVED ==========
   ```

3. 如果没有 `[API]` 日志:
   - 检查猫咪的 `user_id` 是否存在
   - 在 Supabase 中查询: `SELECT user_id FROM cats WHERE id = 'xxx'`

4. 如果有 `[API]` 但没有 `[Notification]`:
   - 检查 Realtime 订阅是否正常
   - 检查通知表的 RLS 是否已禁用

---

## 🎉 预期效果

### 发布人信息显示

```
┌─────────────────────────────────┐
│ [头像] 小憩                     │
│        发布于 2025年12月25日     │
├─────────────────────────────────┤
│ 小憩的猫                         │
│ 3岁 男孩 英国短毛猫              │
│ ...                              │
└─────────────────────────────────┘
```

### 收藏通知

```
顶部弹出 Toast:
┌──────────────────────────────┐
│█                            │
│█ ❤️ 有人收藏了你的猫咪      │
│█    七彩 收藏了 小憩的猫     │
│█    刚刚                     │
└──────────────────────────────┘
```

---

如果还有问题，请提供：
1. Console 中的错误日志
2. Network 标签中 API 请求的响应
3. 数据库中猫咪记录的 user_id 值
