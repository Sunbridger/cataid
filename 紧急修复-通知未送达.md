# 🚨 紧急修复步骤

## 问题：评论回复通知未送达

### 根本原因
数据库中已经创建了通知记录，但由于 RLS (Row Level Security) 策略配置错误，Realtime 无法推送通知到前端。

---

## ✅ 立即执行以下步骤

### 步骤 1: 执行数据库修复 SQL (必须！)

1. 打开 Supabase Dashboard: https://supabase.com/dashboard/project/vljwyjfdpfjmjidbfmcs
2. 点击左侧 **SQL Editor**
3. 点击 **New query**
4. 复制粘贴以下 SQL:

```sql
-- 禁用 RLS 以允许 Realtime 正常工作
ALTER TABLE notifications DISABLE ROW LEVEL SECURITY;

-- 确保 Realtime 已启用
ALTER PUBLICATION supabase_realtime ADD TABLE notifications;

-- 验证配置
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public' AND tablename = 'notifications';
```

5. 点击 **Run** 执行
6. 应该看到 `rowsecurity` 列显示 `false`

---

### 步骤 2: 检查前端 Realtime 连接

打开浏览器开发者工具 (F12)，查看 Console 是否有以下信息：

#### ✅ 正常情况
```
REALTIME SUBSCRIPTIONS LISTENING ON notifications:user-id
```

#### ❌ 错误情况
```
Error: permission denied for table notifications
或
REALTIME ERROR: ...
```

---

### 步骤 3: 测试通知功能

执行 SQL 后，在浏览器中：

1. **刷新页面** (F5)
2. 让"小憩"再次回复"七彩"的评论
3. 查看"七彩"是否收到通知

---

## 🔍 诊断检查

### 检查 1: 数据库中是否有通知记录

在 Supabase SQL Editor 执行:

```sql
-- 查看最近的通知
SELECT
  n.id,
  u.nickname as notify_to,
  n.type,
  n.title,
  n.content,
  n.is_read,
  n.created_at
FROM notifications n
LEFT JOIN users u ON n.user_id = u.id
ORDER BY n.created_at DESC
LIMIT 5;
```

### 检查 2: 评论是否有 user_id

```sql
-- 查看最近的评论
SELECT
  id,
  nickname,
  user_id,
  parent_id,
  content,
  created_at
FROM comments
ORDER BY created_at DESC
LIMIT 5;
```

⚠️ **重要**: 如果 `user_id` 为 NULL，通知将不会创建！

### 检查 3: RLS 状态

```sql
-- 检查 RLS 是否已禁用
SELECT tablename, rowsecurity
FROM pg_tables
WHERE tablename = 'notifications';

-- rowsecurity 应该是 false
```

---

## 🐛 常见问题

### Q1: 数据库中有通知，但前端收不到？
**A**: RLS 策略阻止了 Realtime 推送，执行步骤 1 的 SQL。

### Q2: 评论时 user_id 为空？
**A**: 确保用户已登录，并且评论时传递了 `userId` 参数。

### Q3: 浏览器 Console 显示连接错误？
**A**:
1. 检查 `.env.local` 中的 `VITE_SUPABASE_ANON_KEY` 是否正确
2. 重启开发服务器
3. 清除浏览器缓存

### Q4: 通知创建了但是 is_read 已经是 true？
**A**: 这不会影响通知显示，只是标记状态。

---

## 📊 预期结果

执行修复后，应该看到：

### 数据库
```
✅ notifications 表的 rowsecurity = false
✅ supabase_realtime 发布包含 notifications 表
```

### 浏览器 Console
```
✅ REALTIME SUBSCRIPTIONS LISTENING
✅ 没有权限错误
```

### 前端 UI
```
✅ 导航栏显示未读通知数量
✅ 点击通知图标可以看到通知列表
✅ 新通知实时出现（无需刷新）
```

---

## 🎯 关键点

**最重要的是执行步骤 1 的 SQL！** 这是通知功能不生效的根本原因。

执行后立即测试，应该就能看到通知了。
