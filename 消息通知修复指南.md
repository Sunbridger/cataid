# 消息通知功能修复指南

## 问题分析

消息通知功能不生效的原因有以下几个：

### 1. 前端环境变量缺失 ✅ 已修复
**问题**: `NotificationContext.tsx` 需要 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY` 来初始化 Supabase Realtime 客户端,但 `.env.local` 文件中没有配置。

**修复**: 已在 `.env.local` 中添加以下环境变量:
```bash
VITE_SUPABASE_URL=https://vljwyjfdpfjmjidbfmcs.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 2. 评论功能未创建通知 ✅ 已修复
**问题**: `api/comments.ts` 在提交评论时没有创建通知。

**修复**: 已添加通知创建逻辑:
- 回复评论时,通知被回复的用户
- 新评论时,记录日志(可扩展为通知关注者)

### 3. RLS 策略配置问题 ⚠️ 需要手动执行
**问题**: 通知表的 RLS 策略使用了 `auth.uid()`,但我们没有使用 Supabase Auth,导致 Realtime 无法正常工作。

**修复**: 需要在 Supabase SQL Editor 中执行 `fix_notifications_rls_v2.sql`

## 修复步骤

### 步骤 1: 重启开发服务器
环境变量已更新,需要重启开发服务器以加载新的环境变量:

```bash
# 停止当前运行的开发服务器 (Ctrl+C)
# 然后重新启动
npm run dev
```

### 步骤 2: 执行数据库修复脚本
1. 打开 Supabase Dashboard: https://supabase.com/dashboard
2. 选择项目: vljwyjfdpfjmjidbfmcs
3. 进入 SQL Editor
4. 执行 `fix_notifications_rls_v2.sql` 中的 SQL 语句

### 步骤 3: 验证修复
1. 登录应用
2. 提交一个领养申请
3. 检查是否收到通知(导航栏应显示未读数量)
4. 打开通知页面查看通知列表

### 步骤 4: 测试 Realtime 功能
1. 打开浏览器开发者工具的 Console
2. 应该能看到 Supabase Realtime 的连接日志
3. 当有新通知时,应该实时更新未读数量

## 测试检查清单

- [ ] 环境变量已配置 (`VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY`)
- [ ] 开发服务器已重启
- [ ] 数据库 RLS 策略已修复
- [ ] 提交领养申请后收到通知
- [ ] 回复评论后被回复者收到通知
- [ ] 通知未读数量实时更新
- [ ] 点击通知可标记为已读
- [ ] 可以标记所有通知为已读

## 技术细节

### Supabase Realtime 工作原理
1. 前端使用 `VITE_SUPABASE_ANON_KEY` 连接 Supabase Realtime
2. 订阅 `notifications` 表的 INSERT 事件
3. 当后端插入新通知时,Realtime 推送到前端
4. 前端更新通知列表和未读数量

### 通知创建流程
1. 用户执行操作(提交申请、发表评论等)
2. API 处理业务逻辑
3. API 使用 Service Role Key 插入通知到数据库
4. Supabase Realtime 检测到新记录
5. 推送通知到订阅的前端客户端
6. 前端更新 UI

### 安全说明
- 前端使用 `ANON_KEY`,权限受 RLS 限制
- 后端使用 `SERVICE_ROLE_KEY`,绕过 RLS
- 禁用通知表的 RLS 是安全的,因为:
  - 所有写入操作都通过后端 API
  - 前端只能读取,不能写入
  - 用户只能看到自己的通知(通过 API 过滤)

## 故障排查

### 问题: 通知未实时更新
**检查**:
1. 浏览器 Console 是否有 Supabase 连接错误
2. 环境变量是否正确配置
3. 开发服务器是否已重启

### 问题: 收不到通知
**检查**:
1. 数据库中是否有通知记录
2. RLS 策略是否已禁用
3. Realtime 发布是否包含 notifications 表

### 问题: Realtime 连接失败
**检查**:
1. `VITE_SUPABASE_ANON_KEY` 是否正确
2. Supabase 项目是否正常运行
3. 网络连接是否正常

## 后续优化建议

1. **通知类型扩展**
   - 点赞通知
   - 收藏通知
   - 系统公告

2. **通知设置**
   - 允许用户关闭某些类型的通知
   - 通知声音/震动设置

3. **通知聚合**
   - 相同类型的通知合并显示
   - 批量操作支持

4. **推送通知**
   - 集成 Web Push API
   - 支持离线推送

## 相关文件

- `context/NotificationContext.tsx` - 通知上下文和 Realtime 订阅
- `api/user.ts` - 通知相关 API
- `api/applications.ts` - 申请提交通知
- `api/applications/[id].ts` - 申请审核通知
- `api/comments.ts` - 评论回复通知
- `create_notifications_table.sql` - 通知表创建脚本
- `fix_notifications_rls_v2.sql` - RLS 修复脚本
