<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Realtime æµ‹è¯•</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: 500;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .log {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #007bff;
      padding-left: 10px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”” Supabase Realtime æµ‹è¯•å·¥å…·</h1>

    <div id="status" class="status info">
      æ­£åœ¨åˆå§‹åŒ–...
    </div>

    <div style="margin: 20px 0;">
      <h3>é…ç½®ä¿¡æ¯</h3>
      <div>
        <label>Supabase URL:</label><br>
        <input type="text" id="supabaseUrl" value="https://vljwyjfdpfjmjidbfmcs.supabase.co" />
      </div>
      <div>
        <label>Anon Key:</label><br>
        <input type="text" id="anonKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsand5amZkcGZqbWppZGJmbWNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ3NTk5MzksImV4cCI6MjA1MDMzNTkzOX0.Ks5gYMDJcW_jKLGPKpDZPXUDVVQqYqKvPCDqFPxpVpQ" />
      </div>
      <div>
        <label>ç”¨æˆ· ID (ä¸ƒå½©çš„ user_id):</label><br>
        <input type="text" id="userId" placeholder="è¾“å…¥ä¸ƒå½©çš„ user_id" />
      </div>
    </div>

    <div>
      <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
      <button onclick="subscribe()">è®¢é˜…é€šçŸ¥</button>
      <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="log" id="logs">
      <div class="log-entry">ç­‰å¾…æ“ä½œ...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let supabaseClient = null;
    let channel = null;

    function log(message, type = 'info') {
      const logs = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.style.borderLeftColor = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logs.appendChild(entry);
      logs.scrollTop = logs.scrollHeight;
      console.log(message);
    }

    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…ç©º</div>';
    }

    function testConnection() {
      const url = document.getElementById('supabaseUrl').value;
      const key = document.getElementById('anonKey').value;

      if (!url || !key) {
        updateStatus('âŒ è¯·å¡«å†™ Supabase URL å’Œ Anon Key', 'error');
        log('é”™è¯¯: é…ç½®ä¿¡æ¯ä¸å®Œæ•´', 'error');
        return;
      }

      try {
        log('æ­£åœ¨åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯...');
        supabaseClient = supabase.createClient(url, key);
        log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
        updateStatus('âœ… è¿æ¥æˆåŠŸ', 'success');
      } catch (error) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        updateStatus('âŒ è¿æ¥å¤±è´¥', 'error');
      }
    }

    function subscribe() {
      const userId = document.getElementById('userId').value;

      if (!userId) {
        updateStatus('âŒ è¯·è¾“å…¥ç”¨æˆ· ID', 'error');
        log('é”™è¯¯: ç”¨æˆ· ID ä¸ºç©º', 'error');
        return;
      }

      if (!supabaseClient) {
        updateStatus('âŒ è¯·å…ˆæµ‹è¯•è¿æ¥', 'error');
        log('é”™è¯¯: Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
        return;
      }

      // æ¸…ç†æ—§è®¢é˜…
      if (channel) {
        log('æ¸…ç†æ—§è®¢é˜…...');
        supabaseClient.removeChannel(channel);
      }

      log(`å¼€å§‹è®¢é˜…ç”¨æˆ· ${userId} çš„é€šçŸ¥...`);

      channel = supabaseClient
        .channel(`notifications:${userId}`)
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'notifications',
            filter: `user_id=eq.${userId}`,
          },
          (payload) => {
            log('ğŸ‰ æ”¶åˆ°æ–°é€šçŸ¥!', 'success');
            log(`é€šçŸ¥å†…å®¹: ${JSON.stringify(payload.new, null, 2)}`);
            updateStatus('ğŸ‰ æ”¶åˆ°æ–°é€šçŸ¥!', 'success');
          }
        )
        .subscribe((status) => {
          log(`è®¢é˜…çŠ¶æ€: ${status}`);

          if (status === 'SUBSCRIBED') {
            log('âœ… è®¢é˜…æˆåŠŸ! ç­‰å¾…æ–°é€šçŸ¥...', 'success');
            updateStatus('âœ… è®¢é˜…æˆåŠŸï¼Œç­‰å¾…é€šçŸ¥...', 'success');
          } else if (status === 'CHANNEL_ERROR') {
            log('âŒ è®¢é˜…å¤±è´¥: Channel é”™è¯¯', 'error');
            updateStatus('âŒ è®¢é˜…å¤±è´¥', 'error');
          } else if (status === 'TIMED_OUT') {
            log('âŒ è®¢é˜…è¶…æ—¶', 'error');
            updateStatus('âŒ è®¢é˜…è¶…æ—¶', 'error');
          } else if (status === 'CLOSED') {
            log('âš ï¸ è¿æ¥å·²å…³é—­', 'error');
            updateStatus('âš ï¸ è¿æ¥å·²å…³é—­', 'error');
          }
        });
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
    window.onload = function() {
      log('é¡µé¢åŠ è½½å®Œæˆ');
      log('è¯·è¾“å…¥ä¸ƒå½©çš„ user_idï¼Œç„¶åç‚¹å‡»"æµ‹è¯•è¿æ¥"å’Œ"è®¢é˜…é€šçŸ¥"');
    };
  </script>
</body>
</html>
