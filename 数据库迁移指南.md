# æ•°æ®åº“è¿ç§»æ‰§è¡ŒæŒ‡å—

## âœ… å·²ä¿®å¤çš„é—®é¢˜
- å°†æ‰€æœ‰ `applications` è¡¨åæ”¹ä¸º `adoption_applications`
- ç°åœ¨è„šæœ¬ä¸ä½ çš„å®é™…æ•°æ®åº“è¡¨ååŒ¹é…

## ğŸ“‹ æ‰§è¡Œå‰æ£€æŸ¥æ¸…å•

### 1. ç¡®è®¤ä½ çš„æ•°æ®åº“ä¸­æœ‰è¿™äº›è¡¨ï¼š
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('users', 'cats', 'comments', 'adoption_applications');
```

**é¢„æœŸç»“æœï¼š**
- âœ… `users` - ç”¨æˆ·è¡¨
- âœ… `cats` - çŒ«å’ªè¡¨
- âœ… `comments` - è¯„è®ºè¡¨
- âœ… `adoption_applications` - é¢†å…»ç”³è¯·è¡¨

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ–¹å¼ 1ï¼šå®Œæ•´æ‰§è¡Œï¼ˆæ¨èï¼‰
å¦‚æœä¸Šé¢4ä¸ªè¡¨éƒ½å­˜åœ¨ï¼Œç›´æ¥æ‰§è¡Œæ•´ä¸ª `database-migration.sql` è„šæœ¬ï¼š

1. æ‰“å¼€ Supabase Dashboard
2. è¿›å…¥ SQL Editor
3. å¤åˆ¶ç²˜è´´æ•´ä¸ª `database-migration.sql` æ–‡ä»¶å†…å®¹
4. ç‚¹å‡» **Run** æ‰§è¡Œ

### æ–¹å¼ 2ï¼šåˆ†æ­¥æ‰§è¡Œï¼ˆæ›´å®‰å…¨ï¼‰
å¦‚æœä½ æƒ³æ›´è°¨æ…ï¼Œå¯ä»¥åˆ†æ­¥æ‰§è¡Œï¼š

#### æ­¥éª¤ 1ï¼šåˆ›å»º favorites è¡¨
```sql
-- æ‰§è¡Œç¬¬ 8-30 è¡Œ
CREATE TABLE IF NOT EXISTS favorites (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL,
  cat_id UUID NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  CONSTRAINT fk_favorites_user FOREIGN KEY (user_id)
    REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT fk_favorites_cat FOREIGN KEY (cat_id)
    REFERENCES cats(id) ON DELETE CASCADE,

  CONSTRAINT unique_user_cat UNIQUE(user_id, cat_id)
);

CREATE INDEX IF NOT EXISTS idx_favorites_user_id ON favorites(user_id);
CREATE INDEX IF NOT EXISTS idx_favorites_cat_id ON favorites(cat_id);
CREATE INDEX IF NOT EXISTS idx_favorites_created_at ON favorites(created_at DESC);
```

#### æ­¥éª¤ 2ï¼šæ·»åŠ ç”¨æˆ·ç»Ÿè®¡å­—æ®µ
```sql
-- æ‰§è¡Œç¬¬ 36-38 è¡Œ
ALTER TABLE users
ADD COLUMN IF NOT EXISTS favorite_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS comment_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS adoption_count INTEGER DEFAULT 0;
```

#### æ­¥éª¤ 3ï¼šåˆ›å»ºè§¦å‘å™¨ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
```sql
-- æ‰§è¡Œç¬¬ 48-140 è¡Œ
-- è¿™éƒ¨åˆ†ä¼šåˆ›å»ºè‡ªåŠ¨æ›´æ–°ç»Ÿè®¡æ•°æ®çš„è§¦å‘å™¨
-- å¤åˆ¶ç²˜è´´æ•´ä¸ªè§¦å‘å™¨å‡½æ•°å’Œè§¦å‘å™¨åˆ›å»ºä»£ç 
```

#### æ­¥éª¤ 4ï¼šåˆå§‹åŒ–ç»Ÿè®¡æ•°æ®ï¼ˆå¯é€‰ï¼‰
```sql
-- æ‰§è¡Œç¬¬ 145-170 è¡Œ
-- è¿™ä¼šè®¡ç®—å¹¶å¡«å……ç°æœ‰ç”¨æˆ·çš„ç»Ÿè®¡æ•°æ®
UPDATE users u
SET favorite_count = (
  SELECT COUNT(*) FROM favorites f WHERE f.user_id = u.id
);

UPDATE users u
SET comment_count = (
  SELECT COUNT(*) FROM comments c WHERE c.user_id = u.id AND c.is_ai_reply = FALSE
);

UPDATE users u
SET adoption_count = (
  SELECT COUNT(*) FROM adoption_applications a WHERE a.user_id = u.id
);
```

#### æ­¥éª¤ 5ï¼šé…ç½®å®‰å…¨ç­–ç•¥
```sql
-- æ‰§è¡Œç¬¬ 167-185 è¡Œ
ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own favorites"
ON favorites FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can add favorites"
ON favorites FOR INSERT
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own favorites"
ON favorites FOR DELETE
USING (auth.uid() = user_id);
```

---

## âœ… æ‰§è¡ŒåéªŒè¯

è¿è¡Œè¿™äº›æŸ¥è¯¢ç¡®è®¤ä¸€åˆ‡æ­£å¸¸ï¼š

### 1. æ£€æŸ¥ favorites è¡¨
```sql
-- åº”è¯¥è¿”å›è¡¨ç»“æ„ï¼Œä¸æŠ¥é”™
SELECT * FROM favorites LIMIT 1;
```

### 2. æ£€æŸ¥ users è¡¨çš„æ–°å­—æ®µ
```sql
-- åº”è¯¥èƒ½çœ‹åˆ° favorite_count, comment_count, adoption_count å­—æ®µ
SELECT
  id,
  nickname,
  favorite_count,
  comment_count,
  adoption_count
FROM users
LIMIT 5;
```

### 3. æ£€æŸ¥è§¦å‘å™¨
```sql
-- åº”è¯¥èƒ½çœ‹åˆ°3ä¸ªè§¦å‘å™¨
SELECT
  trigger_name,
  event_object_table,
  action_timing,
  event_manipulation
FROM information_schema.triggers
WHERE trigger_name LIKE '%favorite%'
   OR trigger_name LIKE '%comment%'
   OR trigger_name LIKE '%adoption%';
```

**é¢„æœŸç»“æœï¼š**
- `trigger_update_favorite_count` on `favorites`
- `trigger_update_comment_count` on `comments`
- `trigger_update_adoption_count` on `adoption_applications`

### 4. æ£€æŸ¥ RLS ç­–ç•¥
```sql
-- åº”è¯¥èƒ½çœ‹åˆ°3æ¡ç­–ç•¥
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE tablename = 'favorites';
```

---

## ğŸ¯ å¸¸è§é—®é¢˜

### Q: æ‰§è¡Œæ—¶æŠ¥é”™ "relation does not exist"
**A:** è¯´æ˜æŸä¸ªè¡¨ä¸å­˜åœ¨ï¼Œè·³è¿‡ç›¸å…³çš„ UPDATE è¯­å¥å³å¯

### Q: è§¦å‘å™¨åˆ›å»ºå¤±è´¥
**A:** å¯èƒ½æ˜¯æƒé™é—®é¢˜ï¼Œç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯ service_role æˆ–æœ‰è¶³å¤Ÿæƒé™çš„ç”¨æˆ·

### Q: RLS ç­–ç•¥åˆ›å»ºå¤±è´¥
**A:** æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨åŒåç­–ç•¥ï¼Œå¯ä»¥å…ˆåˆ é™¤å†åˆ›å»º

### Q: ç»Ÿè®¡æ•°å­—éƒ½æ˜¯ 0
**A:**
1. æ£€æŸ¥æ˜¯å¦æ‰§è¡Œäº†æ­¥éª¤ 4 çš„åˆå§‹åŒ–è„šæœ¬
2. æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
3. æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ç»Ÿè®¡æ›´æ–°

---

## ğŸ”„ å›æ»šæ–¹æ³•

å¦‚æœéœ€è¦å›æ»šæ›´æ”¹ï¼š

```sql
-- åˆ é™¤ favorites è¡¨
DROP TABLE IF EXISTS favorites CASCADE;

-- åˆ é™¤ç”¨æˆ·ç»Ÿè®¡å­—æ®µ
ALTER TABLE users
DROP COLUMN IF EXISTS favorite_count,
DROP COLUMN IF EXISTS comment_count,
DROP COLUMN IF EXISTS adoption_count;

-- åˆ é™¤è§¦å‘å™¨
DROP TRIGGER IF EXISTS trigger_update_favorite_count ON favorites;
DROP TRIGGER IF EXISTS trigger_update_comment_count ON comments;
DROP TRIGGER IF EXISTS trigger_update_adoption_count ON adoption_applications;

-- åˆ é™¤è§¦å‘å™¨å‡½æ•°
DROP FUNCTION IF EXISTS update_user_favorite_count();
DROP FUNCTION IF EXISTS update_user_comment_count();
DROP FUNCTION IF EXISTS update_user_adoption_count();
```

---

## ğŸ“Š æ‰§è¡ŒæˆåŠŸæ ‡å¿—

æ‰§è¡ŒæˆåŠŸåï¼Œä½ åº”è¯¥èƒ½ï¼š
1. âœ… åœ¨ä¸ªäººä¸­å¿ƒçœ‹åˆ°æ”¶è—æ•°ã€è¯„è®ºæ•°ã€ç”³è¯·æ•°
2. âœ… è®¿é—®"æˆ‘çš„æ”¶è—"é¡µé¢
3. âœ… æ·»åŠ å’Œåˆ é™¤æ”¶è—
4. âœ… ç»Ÿè®¡æ•°å­—è‡ªåŠ¨æ›´æ–°

---

## ğŸ‰ ä¸‹ä¸€æ­¥

æ•°æ®åº“è¿ç§»å®Œæˆåï¼š
1. é‡å¯ä½ çš„å¼€å‘æœåŠ¡å™¨
2. æµ‹è¯•ä¸ªäººä¸­å¿ƒé¡µé¢çš„ç»Ÿè®¡æ•°æ®
3. æµ‹è¯•æ”¶è—åŠŸèƒ½
4. åœ¨çŒ«å’ªè¯¦æƒ…é¡µæ·»åŠ æ”¶è—æŒ‰é’®ï¼ˆå¾…å®ç°ï¼‰
